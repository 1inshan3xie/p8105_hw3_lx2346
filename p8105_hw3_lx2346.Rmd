---
title: "p8105_hw3_lx2346"
author: "linshan"
date: "2024-10-07"
output: github_document
---

Before start, prepare all the packages will be used
```{r}
library(ggplot2)
library(tidyverse)
library(readxl)
```

## Problem 1
Load the data from the p8105.datasets packages
```{r}
library(p8105.datasets)
data("ny_noaa")
```

### Do some exploration of the dataset.
**size and structure**: The dataset consists of `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Each row represents a daily observation for a given weather station from `r min(ny_noaa$date)` to `r max(ny_noaa$date)`.\
**Key Variables**: The variables in the dataset are `r names(ny_noaa)`. **"id"** represents the unique identifier for each weather station. **"date"** is the date of observation. **"prep"** is precipitation(tenths of mm). **"snow"** is the snowfall(mm), while **"snwd"** is the snow depth(mm). **"tmax"** and **"tmin"** represents the maximum and minmum tempreture.\
** Missing data**: There are missing data in `r names(ny_noaa)[sapply(ny_noaa,anyNA)]`. How many missing data are shown as below. 
```{r}
sapply(ny_noaa,function(x) sum(is.na(x)))
```
So the missing value are particularly noticeable in "tmax" and "tmin".
### Do some data cleaning. Create separate variables for year, month, and day. Ensure observations for temperature, precipitation, and snowfall are given in reasonable units. 
separate the data variable into year, month and day.
```{r}
ny_noaa = separate(ny_noaa, date, into = c("year", "month", "day"), sep = "-", remove = FALSE)
```
 change into reasonable units
```{r}
ny_noaa = ny_noaa |>
  mutate(tmax = as.numeric(tmax),
         tmin = as.numeric(tmin),
         prcp = as.numeric(prcp),
         snow = as.numeric(snow),
         snwd = as.numeric(snwd)) |>
  mutate(tmax = tmax/10,
         tmin = tmin/10,
         prcp = prcp/10)
```
#### For snowfall, what are the most commonly observed values? Why?
```{r}
ny_noaa |>
  count(snow) |>
  arrange(desc(n)) |>
  slice(1)
```
It shows that the value 0 are most commonly observed, which is normal, since it doesn't snow in New York for most of the year.

### Make a two-panel plot showing the average max temperature in January and in July in each station across years.
```{r}
ny_noaa |>
  filter(month == "01" | month == "07") |>
  group_by(month, id) |>
  summarize(mean_tmax = mean(tmax, na.rm = TRUE)) |>
  filter(!if_any(everything(), is.na))|>
  ggplot(aes(x = id, y = mean_tmax, color = month)) +
  geom_point() +
  facet_grid(.~ month, scale = "free_y", labeller = labeller(month = c("01" = "January", "07" = "July"))) +
  labs(
    title = " Average Maximum Temperature in January and in July",
    x = "Weather stations",
    y = "Maximum daily tempreture(C)") +
  theme(plot.title = element_text(hjust = .5), legend.position = "none")
  
```

### Is there any observable / interpretable structure? Any outliers?
It can be observed that **July's tmax is significantly higher than January's**, with most of July's tmax centered around 30 degrees, while most of January's average temperature is centered around 0 degrees. Among the mean maximum temperatures in January, there are three “outliers” around -10 degree Celsius.

### Make a two-panel plot showing tmax vs tmin for the full dataset
```{r}
ny_noaa |>
  pivot_longer(
    tmax:tmin,
    names_to = "ob_t",
    values_to = "tempreture"
  ) |>
  drop_na() |>
  ggplot(aes(x = date, y = tempreture, fill = ob_t)) +
  geom_bin2d(bins = 200, alpha = .8, size = 0.5, na.rm = TRUE) +
  scale_y_continuous(
    breaks = c(-20, -10, 0, 10, 20 ,30, 40),
    labels = c("-20C", "-10C","0C", "10C","20C", "30C", "40C")
  ) +
  scale_fill_discrete(name = "observations") +
  facet_grid(. ~ ob_t)
```

### Make a plot showing the distribution of snowfall values greater than 0 and less than 100 separately by year.
```{r}
ny_noaa |>
  filter(snow > 0, snow < 100) |>
  ggplot(aes(x = year, y = snow)) + 
  geom_violin(aes(fill = year), alpha = .5) +
  scale_x_discrete(
    breaks = c(1981, 1985, 1990, 1995, 2000, 2005, 2010),
    labels = c("1981", "1985","1990", "1995","2000", "2005", "2010")
  ) +
  stat_summary(fun = "median", color = "black", size = .1)
```

## Problem 2
Load the two dataset first.
```{r}
demo = read_csv("./data/nhanes_covar.csv", skip = 4, na = "NA") |>
  janitor::clean_names() |>
  mutate(
    sex = 
      case_match(
        sex, 
        1 ~ "male", 
        2 ~ "female"),
    sex = as.factor(sex)) |>
  mutate(
    education = 
      case_match(
        education,
        1 ~ "Less than high school",
        2 ~ "High school equivalent",
        3 ~ "More than high school"),
    education = as.factor(education))

accel = read_csv("./data/nhanes_accel.csv") |>
  janitor::clean_names()
```

Then, merge the two data set together.
```{r}
nhanes = left_join(demo,accel, by = "seqn")
```

Then, exclude participants less than 21 years of age, and those with missing demographic data.
```{r}
nhanes = filter(nhanes, age >= 21)
nhanes = filter(nhanes, !is.na(sex), !is.na(age), !is.na(bmi), !is.na(education))
nhanes
```

### Produce a reader-friendly table for the number of men and women in each education category
```{r}
nhanes |>
  group_by(sex,education) |>
  summarize(count = n()) |>
  pivot_wider(
    names_from = "education",
    values_from = "count"
  ) |>
  knitr::kable()
```

### Create a visualization of the age distributions for men and women in each education category.
```{r}
nhanes |>
  group_by(sex,education) |>
  ggplot(aes(x = education, y = age, color = education)) +
  geom_boxplot() +
  facet_grid(. ~ sex ) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```
\
**Comment**: It can be seen that the age distribution of the males and females who participated in the accelerometers survey was similar according to their level of education, with subjects whose education was more than high school being younger, around 40-60 years old, and those whose education was high school equivalent or more than high school being mostly between 45-70 years old.\

### Analyses of accelerometer data
#### Create a total activity variable
```{r}
nhanes = mutate(nhanes, total_activity = rowSums(select(nhanes, 6:1445)))
nhanes = select(nhanes, seqn, sex, age, bmi, education, total_activity, everything())
```
#### Plot these total activities (y-axis) against age (x-axis); compare men to women and have separate panels for each education level. Include a trend line or a smooth to illustrate differences. 
```{r}
nhanes |>
  group_by(sex,education) |>
  ggplot(aes(x = age, y = total_activity, colour = sex)) +
  geom_point(alpha = .5, size = 1.5) +
  geom_smooth(se = FALSE, size = 1) +
  facet_grid(. ~ education)
```
\
**Comment**: It can be seen that the highest intensity of total activity occurs at different ages at different levels of education, with the highest activity occurring at roughly age 40 among participants in the high school equivalent, and with female having higher total activity than male. In contrast, among participants less than high school, females had higher total activity than males up to age 40, and the opposite was true after age 40. Their highest total activity occurred at a later age of 60. Among participants from more than high school, their total activity curves were smoother and peaked at different ages for males and females, around 45 years for males and 60 years for females.

### Make a three-panel plot that shows the 24-hour activity time courses for each education level and use color to indicate sex.
```{r}
nhanes |>
  pivot_longer(
    min1:min1440,
    names_to = "time",
    values_to = "activity",
    names_prefix = "min"
  ) |>
  mutate(time = as.numeric(time)) |>
  mutate(time = time/60) |>
  group_by(education, sex) |>
  ggplot(aes(x = time, y = activity, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_grid(. ~ education) +
  labs(title = "24-hour activity time courses by education and sex",
       x = "Time(Hours)",
       y = "Activity(MIMS)") +
  scale_x_continuous(breaks = seq(0, 24, by = 3))
```
\
**Comment**：Looking at the curves in the three pairs of images, it can be seen that, regardless of education level, participants had higher activity intensities during the day from 9 am to 6 pm, and the lowest activity intensities (at the nadir) at around 4 am. In the high school equivalent and less than high school groups, there was no significant difference in the distribution of activity intensity between males and females over the 24-hour period. In the More than High school group, a small low peak for males around 4 p.m. and a lower activity intensity curve for males below that of females can be observed.
























